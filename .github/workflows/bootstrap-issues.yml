name: Bootstrap Labels + Issue Menu + Milestones

on:
  push:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      force:
        description: "Re-run even if labels/issues/milestones already exist"
        required: false
        default: "false"

permissions:
  contents: read
  issues: write

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    steps:
      - name: Bootstrap labels, milestones, and issues via GitHub REST API
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          FORCE: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.force) || 'false' }}
        run: |
          set -euo pipefail

          API_STATUS=""

          # Usage: api METHOD PATH DATA OUTVAR
          api() {
            local method="$1"
            local path="$2"
            local data="${3:-}"
            local outvar="$4"

            local url="https://api.github.com${path}"
            local tmp
            tmp="$(mktemp)"

            if [[ -n "${data}" ]]; then
              API_STATUS="$(curl -sS -o "${tmp}" -w "%{http_code}" \
                -X "${method}" \
                -H "Accept: application/vnd.github+json" \
                -H "Authorization: Bearer ${GH_TOKEN}" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                "${url}" \
                -d "${data}")"
            else
              API_STATUS="$(curl -sS -o "${tmp}" -w "%{http_code}" \
                -X "${method}" \
                -H "Accept: application/vnd.github+json" \
                -H "Authorization: Bearer ${GH_TOKEN}" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                "${url}")"
            fi

            printf -v "${outvar}" '%s' "$(cat "${tmp}")"
            rm -f "${tmp}"
          }

          urlencode() {
            python3 -c 'import urllib.parse,sys; print(urllib.parse.quote(sys.argv[1], safe=""))' "$1"
          }

          # ---------- Guard helpers (skip only if BOTH exist) ----------

          any_issues_exist() {
            local q encq resp total
            q="repo:${REPO} is:issue"
            encq="$(python3 -c 'import urllib.parse,sys; print(urllib.parse.quote(sys.argv[1]))' "$q")"

            api GET "/search/issues?q=${encq}&per_page=1" "" resp
            if [[ "${API_STATUS}" != "200" ]]; then
              echo "ERROR: search/issues failed (HTTP ${API_STATUS})" >&2
              echo "${resp}" >&2
              exit 1
            fi

            total="$(echo "${resp}" | jq -r '.total_count')"
            [[ "${total}" != "0" ]]
          }

          any_milestones_exist() {
            local resp
            api GET "/repos/${REPO}/milestones?state=all&per_page=1" "" resp
            if [[ "${API_STATUS}" != "200" ]]; then
              echo "ERROR: milestones list failed (HTTP ${API_STATUS})" >&2
              echo "${resp}" >&2
              exit 1
            fi
            [[ "$(echo "${resp}" | jq 'length')" != "0" ]]
          }

          # ---------- Labels ----------

          ensure_label() {
            local name="$1"
            local color="$2"
            local desc="$3"
            local enc payload patch resp

            enc="$(urlencode "$name")"

            payload="$(jq -n --arg name "$name" --arg color "$color" --arg description "$desc" \
              '{name:$name,color:$color,description:$description}')"

            api POST "/repos/${REPO}/labels" "${payload}" resp
            if [[ "${API_STATUS}" == "201" ]]; then
              echo "Created label: ${name}" >&2
              return 0
            fi

            if [[ "${API_STATUS}" == "422" ]]; then
              patch="$(jq -n --arg new_name "$name" --arg color "$color" --arg description "$desc" \
                '{new_name:$new_name,color:$color,description:$description}')"

              api PATCH "/repos/${REPO}/labels/${enc}" "${patch}" resp
              if [[ "${API_STATUS}" == "200" ]]; then
                echo "Updated label: ${name}" >&2
                return 0
              fi
            fi

            echo "ERROR: ensure_label failed for ${name} (HTTP ${API_STATUS})" >&2
            echo "${resp}" >&2
            exit 1
          }

          # ---------- Milestones ----------

          milestone_number_by_title() {
            local title="$1"
            local resp num
            api GET "/repos/${REPO}/milestones?state=all&per_page=100" "" resp
            if [[ "${API_STATUS}" != "200" ]]; then
              echo "ERROR: milestones list failed (HTTP ${API_STATUS})" >&2
              echo "${resp}" >&2
              exit 1
            fi
            num="$(echo "${resp}" | jq -r --arg t "${title}" '.[] | select(.title==$t) | .number' | head -n 1)"
            [[ "${num}" == "null" ]] && num=""
            echo "${num}"
          }

          ensure_milestone() {
            local title="$1"
            local description="$2"
            local existing payload resp num

            existing="$(milestone_number_by_title "${title}")"
            if [[ -n "${existing}" ]]; then
              echo "Milestone exists: ${title} (#${existing})" >&2
              echo "${existing}"
              return 0
            fi

            payload="$(jq -n --arg title "$title" --arg description "$description" \
              '{title:$title, description:$description}')"

            api POST "/repos/${REPO}/milestones" "${payload}" resp
            if [[ "${API_STATUS}" != "201" ]]; then
              echo "ERROR: create milestone failed for ${title} (HTTP ${API_STATUS})" >&2
              echo "${resp}" >&2
              exit 1
            fi

            num="$(echo "${resp}" | jq -r '.number')"
            echo "Created milestone: ${title} (#${num})" >&2
            echo "${num}"
          }

          # ---------- Issues (create OR update existing) ----------

          labels_csv_to_json() {
            local labels_csv="$1"
            printf '%s' "${labels_csv}" \
              | awk -F',' '{for (i=1;i<=NF;i++) print $i}' \
              | sed '/^\s*$/d' \
              | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' \
              | jq -R . | jq -s .
          }

          # Reliable exact-title lookup by LISTING issues (not Search)
          issue_number_by_title_list() {
            local title="$1"
            local page=1 resp num

            while true; do
              api GET "/repos/${REPO}/issues?state=all&per_page=100&page=${page}" "" resp
              if [[ "${API_STATUS}" != "200" ]]; then
                echo "ERROR: list issues failed (HTTP ${API_STATUS})" >&2
                echo "${resp}" >&2
                exit 1
              fi

              if [[ "$(echo "${resp}" | jq 'length')" == "0" ]]; then
                break
              fi

              num="$(echo "${resp}" | jq -r --arg t "${title}" \
                '.[] | select(.pull_request==null) | select(.title==$t) | .number' | head -n 1)"
              [[ "${num}" == "null" ]] && num=""

              if [[ -n "${num}" ]]; then
                echo "${num}"
                return 0
              fi

              page=$((page + 1))
            done

            echo ""
          }

          ensure_issue() {
            local title="$1"
            local labels_csv="$2"
            local body="$3"

            local existing_num labels_json payload resp num
            existing_num="$(issue_number_by_title_list "${title}")"
            labels_json="$(labels_csv_to_json "${labels_csv}")"

            if [[ -n "${existing_num}" ]]; then
              payload="$(jq -n \
                --arg body "${body}" \
                --argjson labels "${labels_json}" \
                '{body:$body, labels:$labels}')"

              api PATCH "/repos/${REPO}/issues/${existing_num}" "${payload}" resp
              if [[ "${API_STATUS}" != "200" ]]; then
                echo "ERROR: update issue failed (HTTP ${API_STATUS}) for ${title} (#${existing_num})" >&2
                echo "${resp}" >&2
                exit 1
              fi

              echo "Updated issue: ${title} (#${existing_num})" >&2
              echo "${existing_num}"
              return 0
            fi

            payload="$(jq -n \
              --arg title "${title}" \
              --arg body "${body}" \
              --argjson labels "${labels_json}" \
              '{title:$title, body:$body, labels:$labels}')"

            api POST "/repos/${REPO}/issues" "${payload}" resp
            if [[ "${API_STATUS}" != "201" ]]; then
              echo "ERROR: create issue failed (HTTP ${API_STATUS}) for ${title}" >&2
              echo "${resp}" >&2
              exit 1
            fi

            num="$(echo "${resp}" | jq -r '.number')"
            echo "Created issue: ${title} (#${num})" >&2
            echo "${num}"
          }

          assign_issue_to_milestone() {
            local issue_number="$1"
            local milestone_number="$2"
            local payload resp

            payload="$(jq -n --argjson milestone "$milestone_number" '{milestone:$milestone}')"

            api PATCH "/repos/${REPO}/issues/${issue_number}" "${payload}" resp
            if [[ "${API_STATUS}" != "200" ]]; then
              echo "ERROR: assign milestone failed for issue #${issue_number} (HTTP ${API_STATUS})" >&2
              echo "${resp}" >&2
              exit 1
            fi
          }

          # Reliable assignment pass: list issues (not search) and assign by [P#] prefix.
          assign_all_existing_issues_to_milestones() {
            local page=1
            while true; do
              local resp
              api GET "/repos/${REPO}/issues?state=all&per_page=100&page=${page}" "" resp
              if [[ "${API_STATUS}" != "200" ]]; then
                echo "ERROR: list issues failed (HTTP ${API_STATUS})" >&2
                echo "${resp}" >&2
                exit 1
              fi

              if [[ "$(echo "${resp}" | jq 'length')" == "0" ]]; then
                break
              fi

              echo "${resp}" | jq -r '.[] | select(.pull_request==null) | "\(.number)\t\(.title)"' \
                | while IFS=$'\t' read -r num title; do
                    local ms=""
                    case "${title}" in
                      "[P1]"*) ms="${MS_P1}" ;;
                      "[P2]"*) ms="${MS_P2}" ;;
                      "[P3]"*) ms="${MS_P3}" ;;
                      "[P4]"*) ms="${MS_P4}" ;;
                      *) ms="" ;;
                    esac

                    if [[ -n "${ms}" ]]; then
                      assign_issue_to_milestone "${num}" "${ms}"
                      echo "Assigned issue #${num} -> milestone #${ms} (${title})" >&2
                    fi
                  done

              page=$((page + 1))
            done
          }

          create_and_assign() {
            local title="$1"
            local labels="$2"
            local body="$3"
            local num
            num="$(ensure_issue "${title}" "${labels}" "${body}")"
            echo "Ensured issue #${num} for ${title}" >&2
          }

          echo "Repo: ${REPO}" >&2
          echo "Force: ${FORCE}" >&2

          # Skip ONLY if BOTH issues exist AND milestones exist (unless forced).
          if [[ "${FORCE}" != "true" ]]; then
            if any_issues_exist && any_milestones_exist; then
              echo "Repo already has issues AND milestones; skipping bootstrap." >&2
              exit 0
            fi
          fi

          echo "Creating/updating labels..." >&2
          ensure_label "P1" "1f77b4" "Project 1"
          ensure_label "P2" "ff7f0e" "Project 2"
          ensure_label "P3" "2ca02c" "Project 3"
          ensure_label "P4" "d62728" "Project 4"

          ensure_label "size/S" "a1d99b" "Small scope"
          ensure_label "size/M" "74c476" "Medium scope"
          ensure_label "size/L" "238b45" "Large scope"

          ensure_label "type/bug" "e15759" "Bug fix"
          ensure_label "type/refactor" "4e79a7" "Refactoring / design cleanup"
          ensure_label "type/feature" "59a14f" "New feature"
          ensure_label "type/tests" "f28e2b" "Testing work"
          ensure_label "type/devops" "edc949" "DevOps / CI / release"

          ensure_label "area/ui" "76b7b2" "UI / UX"
          ensure_label "area/security" "b07aa1" "Security / auth"
          ensure_label "area/data" "9c755f" "Data model / DB"

          # Anchor labels
          ensure_label "anchor/patterns" "9467bd" "Requires an explicit design pattern application"
          ensure_label "anchor/smells-antipatterns" "8c564b" "Requires identifying and correcting a code smell or anti-pattern"

          echo "Creating/updating milestones (reverse order so newest shows P1 on top)..." >&2
          # Create in reverse order: P4 -> P3 -> P2 -> P1
          MS_P4="$(ensure_milestone "P4" "Project 4: DevOps/quality gates + release discipline")"
          MS_P3="$(ensure_milestone "P3" "Project 3: feature work with clean design + tests")"
          MS_P2="$(ensure_milestone "P2" "Project 2: maintainability rescue + larger refactoring")"
          MS_P1="$(ensure_milestone "P1" "Project 1: foundational tests + small refactors/bug fixes")"

          echo "Ensuring issues (create/update) in reverse order so newest shows P1 on top..." >&2

          # ============================================================
          # P4 (create first so it appears lower when sorted by newest)
          # Desired display order (top->bottom when sorted newest): CI -> Compose -> Flyway -> Testcontainers -> Correlation -> Actuator
          # Create in reverse of desired display:
          # ============================================================

          create_and_assign "[P4][M] Harden Actuator usage (health/info + security)" "P4,size/M,type/devops,area/security" $'## Problem / context\nActuator can leak info if misconfigured.\n\n## Goal\nExpose minimal actuator endpoints and secure them.\n\n## Work required\n- Configure actuator exposure to minimal endpoints (`health`, `info`).\n- Protect endpoints appropriately (role-based or restricted access) and document choice.\n- Add at least one test verifying anonymous access is denied (or intentionally allowed with justification).\n\n## Acceptance criteria\n- Actuator exposure is minimal and intentional.\n- Security behavior tested.\n- Docs updated.'

          create_and_assign "[P4][M] Add structured logging + request correlation IDs + troubleshooting guide" "P4,size/M,type/devops,anchor/patterns,anchor/smells-antipatterns" $'## Smell / anti-pattern to address\n- **Scattered Logging** and **Observability Gap**\n\n## Pattern required\n- **Servlet Filter / Interceptor** (cross-cutting concern implementation)\n\n## Context\nWithout correlation IDs, debugging multi-step requests is painful.\n\n## Work required\n1) Implement a request-level filter/interceptor that:\n   - reads `X-Correlation-Id` or generates one\n   - stores it in MDC\n   - returns it in the response header\n2) Update logging pattern to include correlation ID.\n3) Add `TROUBLESHOOTING.md` with:\n   - how to get correlation ID from browser/network tab\n   - how to grep logs by correlation ID\n   - common failure modes and what logs to capture\n\n## Evidence to grade\n- **Tests:** at least **1 integration test** verifying:\n  - response includes `X-Correlation-Id` header\n  - repeated requests preserve or generate appropriately\n- **Design note:** `docs/design-notes/P4-correlation-id.md`:\n  - what scattered logging looked like\n  - why Filter/Interceptor is the right pattern for cross-cutting concerns\n\n## Acceptance criteria\n- Every request produces a correlation ID in logs and response.\n- Troubleshooting doc exists and is actionable.\n- Tests pass.'

          create_and_assign "[P4][M/L] Add Testcontainers-based integration tests for repositories" "P4,size/M,type/tests,type/devops" $'## Problem / context\nIn-memory DB tests may hide Postgres-specific issues.\n\n## Goal\nRun integration tests against Postgres Testcontainers.\n\n## Work required\n- Add Testcontainers dependencies/config.\n- Create integration tests for at least:\n  - one repository query\n  - one service path hitting the DB\n- Ensure CI runs reliably.\n- Document local run instructions.\n\n## Acceptance criteria\n- Tests run with Postgres container in CI.\n- Real query behavior validated.\n- Docs included.'

          create_and_assign "[P4][L] Introduce Flyway migrations and stop using \`ddl-auto=update\`" "P4,size/L,type/devops,area/data" $'## Problem / context\n`ddl-auto=update` is unsafe and non-reproducible.\n\n## Goal\nManage schema via migrations; app boots clean on empty DB.\n\n## Work required\n- Add Flyway dependency/config.\n- Create baseline migration for current schema.\n- Set ddl-auto to `validate` or `none` for non-dev.\n- Document dev reset workflow.\n\n## Acceptance criteria\n- Fresh DB + migrations boots successfully.\n- No reliance on ddl-auto=update outside dev.\n- Docs updated.'

          create_and_assign "[P4][M] Add Docker Compose for local run (app + Postgres) + docs" "P4,size/M,type/devops" $'## Problem / context\nLocal setup varies; Compose provides consistency.\n\n## Goal\nOne-command local run with app + Postgres.\n\n## Work required\n- Add `docker-compose.yml` for Postgres + app.\n- Use env vars (no secrets committed).\n- README: `docker compose up --build`, ports, and how to reset volumes.\n\n## Acceptance criteria\n- Clean machine can run via compose.\n- Docs accurate.\n- No secrets committed.'

          create_and_assign "[P4][M] Add CI pipeline with required checks (tests + formatting)" "P4,size/M,type/devops,type/tests" $'## Problem / context\nNo enforced quality gates.\n\n## Goal\nCI runs tests and at least one formatting/static check.\n\n## Work required\n- Add GitHub Actions workflow for PRs running:\n  - `mvn test`\n  - one quality gate (Spotless/Checkstyle/SpotBugs)\n- Document local commands.\n\n## Acceptance criteria\n- CI runs on PR and fails on issues.\n- At least one quality gate enforced.\n- Docs updated.'

          # ============================================================
          # P3
          # Desired display (top->bottom newest): Filters -> Pagination -> Notes -> REST API -> Budgets -> Recurring -> CSV import -> Split
          # Create in reverse:
          # ============================================================

          create_and_assign "[P3][L] Split a transaction across multiple categories" "P3,size/L,type/feature,area/data" $'## Problem / context\nSingle purchases can span multiple categories.\n\n## Goal\nSupport splitting a transaction into category line items.\n\n## Work required\n- Add model:\n  - Transaction header (total)\n  - Line items (category, amount)\n- UI supports add/remove line items and enforces sum(items) == total.\n- Update charts/totals to use line items for category breakdown.\n- Add tests for sum constraint and persistence.\n\n## Acceptance criteria\n- Split transactions work end-to-end.\n- Charts/totals reflect line item categories.\n- Constraint enforced with user-friendly errors.\n- Tests included.'

          create_and_assign "[P3][L] CSV import with preview + validation report" "P3,size/L,type/feature,type/tests" $'## Problem / context\nUsers may have bank CSVs to import.\n\n## Goal\nUpload CSV -> preview -> validate -> import.\n\n## Work required\n- Add upload endpoint + UI.\n- Parse CSV using documented schema.\n- Preview page shows parsed rows and per-row validation errors.\n- Confirm step imports (all valid or “import valid only” documented).\n- Add tests for parsing and validation.\n\n## Acceptance criteria\n- Preview before import.\n- Clear validation messages with row numbers.\n- Correct persistence after confirmation.\n- Tests included.'

          create_and_assign "[P3][L] Recurring income/expense rules" "P3,size/L,type/feature,area/data" $'## Problem / context\nUsers often have recurring entries; manual entry is tedious.\n\n## Goal\nAdd recurring rules and generate future instances safely.\n\n## Work required\n- Add recurrence entity (weekly/monthly, start/end, amount, category, description).\n- Add generation mechanism (on dashboard load or button) that is idempotent.\n- Prevent duplicates.\n- Define policy for month-end (Jan 31 -> Feb 28/29) and document it.\n- Add tests for month boundary and duplicate prevention.\n\n## Acceptance criteria\n- Generated instances match rules through a horizon.\n- No duplicates on repeated generation.\n- Tests cover edge cases.'

          create_and_assign "[P3][L] Implement monthly budgets per category" "P3,size/L,type/feature,area/data" $'## Problem / context\nApp tracks spending but does not support planning against budgets.\n\n## Goal\nAllow users to set monthly category budgets and see remaining/over-budget.\n\n## Work required\n- Add model/table: `CategoryBudget(user, yearMonth, category, amount)`.\n- Add UI to create/update budgets for a month.\n- Update dashboard to show spent vs budget per category.\n- Add tests for calculations and over-budget behavior.\n- Document migration approach.\n\n## Acceptance criteria\n- Users can set budgets and see status per category.\n- Clear behavior when budget is missing (document choice).\n- Tests included.'

          create_and_assign "[P3][M/L] Add a small REST API (read-only) for transactions + incomes" "P3,size/M,type/feature,anchor/patterns,anchor/smells-antipatterns" $'## Smell / anti-pattern to address\n- **Leaky Abstraction** / **Expose Entities** anti-pattern\n\n## Pattern required\n- **DTO** + **Assembler/Mapper** (a boundary component that maps entities to DTOs)\n\n## Context\nExposing JPA entities directly from controllers couples your API to persistence shape.\n\n## Work required\n1) Implement read-only endpoints:\n   - `GET /api/transactions`\n   - `GET /api/incomes`\n2) Create DTOs and a mapper/assembler component (entities -> DTO).\n3) Enforce user scoping (only return logged-in user’s records).\n\n## Evidence to grade\n- **Tests:** at least **2 integration tests**\n  - anonymous denied (401/403)\n  - authenticated receives only their data (not other users)\n- **Design note:** `docs/design-notes/P3-api-dto-boundary.md`:\n  - why exposing entities is an anti-pattern\n  - what the DTO boundary protects you from (schema changes, lazy loading, accidental leaks)\n\n## Acceptance criteria\n- Endpoints are secure and scoped.\n- Entities are not serialized directly.\n- Tests pass.'

          create_and_assign "[P3][M] Add “notes” field and display it everywhere relevant" "P3,size/M,type/feature" $'## Problem / context\nUsers want additional detail beyond description.\n\n## Goal\nAdd optional notes field and ensure it appears consistently.\n\n## Work required\n- Add `notes` field to relevant entity/entities.\n- Update create/edit/list/detail views.\n- Include notes in CSV export.\n- Add tests verifying persistence and export includes notes.\n\n## Acceptance criteria\n- Notes can be saved/edited and displayed.\n- Export includes notes column.\n- Tests included.'

          create_and_assign "[P3][M] Add pagination for transactions and incomes" "P3,size/M,type/feature" $'## Problem / context\nLarge lists are slow and hard to use.\n\n## Goal\nAdd pagination with stable sorting.\n\n## Work required\n- Use Spring Data `Pageable` queries.\n- UI shows pagination controls (next/prev + page indicator).\n- Preserve filters across page navigation if filters exist.\n- Add tests for paging boundaries and sorting.\n\n## Acceptance criteria\n- Lists are paginated and remain newest-first.\n- Navigation works at first/last pages.\n- Tests included.'

          create_and_assign "[P3][M] Add filters: date range + category + text search" "P3,size/M,type/feature,area/ui,anchor/patterns,anchor/smells-antipatterns" $'## Smell / anti-pattern to address\n- **Long Parameter List** and **Conditional Query Explosion**\n\n## Pattern required\n- **Specification Pattern** (preferred) OR **Query Object**\n\n## Context\nAdding filters often leads to many repository methods or deeply nested conditionals.\n\n## Work required\n1) Implement filtering using:\n   - Spring Data JPA Specifications (preferred), OR\n   - a Query Object (e.g., `TransactionFilter { startDate, endDate, category, queryText }`)\n2) Ensure filters can combine without creating N repository methods.\n3) Decide whether totals/charts reflect filtered results or full period, and document the choice.\n\n## Evidence to grade\n- **Tests:** at least **3 tests** at service/repo level:\n  - date range + category\n  - category + text\n  - all filters combined\n- **Design note:** `docs/design-notes/P3-filter-specification.md`:\n  - what conditional explosion you avoided\n  - how specs/query object composes cleanly\n\n## Acceptance criteria\n- Filters compose correctly and are easy to extend.\n- Behavior documented.\n- Tests pass.'

          # ============================================================
          # P2
          # Desired display (top->bottom newest): Service layer -> Dedup summary -> PeriodStrategy -> ControllerAdvice -> Unique usernames -> DataSeeder -> BigDecimal -> Base entity
          # Create in reverse:
          # ============================================================

          create_and_assign "[P2][L] Introduce a shared base entity for \`Income\` and \`Transaction\`" "P2,size/L,type/refactor" $'## Problem / context\nIncome/Transaction duplicate mapping/fields.\n\n## Goal\nReduce duplication while keeping JPA mapping correct.\n\n## Work required\n- Introduce a `@MappedSuperclass` or composition for shared fields (amount/date/description/user).\n- Refactor entities to use shared structure.\n- Update repositories/services as needed.\n- Add at least one persistence-focused test to ensure mappings still work.\n\n## Acceptance criteria\n- Duplication reduced.\n- Behavior unchanged.\n- Persistence tests pass.'

          create_and_assign "[P2][L] Replace \`double\` amounts with \`BigDecimal\` (money correctness)" "P2,size/L,type/refactor,type/tests,area/data,anchor/patterns,anchor/smells-antipatterns" $'## Smell / anti-pattern to address\n- **Primitive Obsession** and **Inaccurate Monetary Calculations**\n\n## Pattern required\n- **Value Object Pattern** (Money)\n\n## Context\nUsing `double` for currency introduces rounding errors.\n\n## Work required\n1) Replace money fields with `BigDecimal`.\n2) Introduce a Money Value Object (even a small wrapper) that centralizes:\n   - rounding mode\n   - scale (e.g., 2 decimal places)\n   - safe add/subtract\n3) Update calculations, charts, and exports to use Money consistently.\n\n## Evidence to grade\n- **Tests:** at least **3 tests**\n  - demonstrates a classic floating-point issue is fixed (e.g., 0.1 + 0.2 == 0.3 equivalent)\n  - aggregation totals are correct with multiple entries\n  - rounding behavior is consistent and documented\n- **Design note:** `docs/design-notes/P2-money-value-object.md`:\n  - why Primitive Obsession applies\n  - why Money beats scattered `setScale()` calls\n\n## Acceptance criteria\n- No currency stored or computed as `double`.\n- Totals correct and consistent.\n- Tests pass in CI.'

          create_and_assign "[P2][S] Make \`DataSeeder\` run only in dev profile" "P2,size/S,type/refactor" $'## Problem / context\nSeeder data can interfere with tests/production-like environments.\n\n## Goal\nSeeder runs only when explicitly enabled for dev.\n\n## Work required\n- Gate seeder behind `@Profile("dev")` or a config flag like `app.seed=true`.\n- Ensure tests run without seeding.\n- Update README: how to enable seeding locally.\n\n## Acceptance criteria\n- Default runs/tests do not seed.\n- Dev seeding can be enabled intentionally.\n- README updated.'

          create_and_assign "[P2][M] Enforce unique usernames + improve registration validation" "P2,size/M,type/feature,area/security,type/tests" $'## Problem / context\nDuplicate usernames may be possible; UX on conflict may be poor.\n\n## Goal\nEnforce uniqueness at DB + app level with friendly error handling.\n\n## Work required\n- Add DB uniqueness constraint on username.\n- Add registration validation:\n  - detect existing username\n  - show clear message and keep user on registration form\n- Add tests:\n  - successful registration\n  - duplicate username fails gracefully\n\n## Acceptance criteria\n- Duplicate usernames cannot be created.\n- User sees a clear error message.\n- Tests included.'

          create_and_assign "[P2][M] Add \`@ControllerAdvice\` for consistent error handling" "P2,size/M,type/refactor" $'## Problem / context\nErrors are inconsistent and may show generic or unfriendly pages.\n\n## Goal\nCentralize error handling for common failures.\n\n## Work required\n- Add `@ControllerAdvice` handling:\n  - not found (missing entity)\n  - unauthorized access to another user’s entity (if applicable)\n  - validation failures (if routed as exceptions)\n  - generic fallback\n- For HTML: return a friendly error view.\n- For JSON (if any endpoints): return consistent JSON error payload.\n- Add tests:\n  - one HTML error scenario\n  - one JSON error scenario (or document if no JSON yet).\n\n## Acceptance criteria\n- Errors are consistent and user-friendly.\n- No stack traces leak to users.\n- Tests included.'

          create_and_assign "[P2][M] Replace “Month = now” with a \`PeriodStrategy\`" "P2,size/M,type/refactor,type/feature,anchor/patterns,anchor/smells-antipatterns" $'## Smell / anti-pattern to address\n- **Conditional Complexity** (if/else expansion) and **Feature Envy**\n\n## Pattern required\n- **Strategy Pattern**\n\n## Context\nHardcoded "current month" logic invites future if/else sprawl when adding new periods.\n\n## Work required\n1) Define a `PeriodStrategy` interface producing a `DateRange` (or `YearMonth`).\n2) Implement at least two strategies:\n   - `CurrentMonthStrategy` (default)\n   - `SelectedMonthStrategy` (from `?month=YYYY-MM`)\n3) Update summary facade/service to accept a strategy (or a resolved date range).\n\n## Evidence to grade\n- **Tests:** at least **2 unit tests**\n  - correct date range for current month\n  - correct date range for selected month\n- **Design note:** `docs/design-notes/P2-period-strategy.md`:\n  - what conditional complexity you avoided\n  - why Strategy fits better than a switch on query params\n\n## Acceptance criteria\n- Users can request a specific month via query param.\n- No period-selection if/else chain grows in controllers.\n- Tests pass.'

          create_and_assign "[P2][M] Deduplicate monthly summary calculations (home + dashboard)" "P2,size/M,type/refactor,anchor/patterns,anchor/smells-antipatterns" $'## Smell / anti-pattern to address\n- **Duplicate Code** and **Shotgun Surgery**\n\n## Pattern required\n- **Facade** (summary computation entry point)\n- **Value Object** (summary DTO with invariants)\n\n## Context\nSummary logic duplicated across endpoints leads to inconsistent results and requires fixes in multiple places.\n\n## Work required\n1) Create `CashflowSummaryService` as a Facade for summary computation.\n2) Return a Value Object (e.g., `MonthlyCashflowSummary`) containing:\n   - income total, spending total, net, category totals\n   - invariants: no null totals; consistent rounding rules\n3) Controllers call the facade instead of duplicating logic.\n\n## Evidence to grade\n- **Tests:** at least **3 unit tests**\n  - empty dataset -> totals are 0\n  - mixed dataset -> correct totals\n  - boundary dates -> only correct month included\n- **Design note:** `docs/design-notes/P2-summary-facade.md` explaining:\n  - what was duplicated and why it causes Shotgun Surgery\n  - why a Value Object is better than a loose map of numbers\n\n## Acceptance criteria\n- No duplicated monthly totals blocks remain in controllers.\n- Summary logic is covered by tests.\n- UI still shows correct values.'

          create_and_assign "[P2][M] Introduce service layer for transactions/incomes (thin controllers)" "P2,size/M,type/refactor,anchor/patterns,anchor/smells-antipatterns" $'## Smell / anti-pattern to address\n- **God Controller** and **Transaction Script**\n\n## Pattern required\n- **Service Layer** (required)\n- **Facade** (optional but encouraged for cross-entity workflows)\n\n## Context\nControllers doing validation, ownership checks, and CRUD details become hard to test and hard to change.\n\n## Work required\n1) Identify controller methods exhibiting God Controller behavior.\n2) Create a Service Layer:\n   - `TransactionService`, `IncomeService` with cohesive operations (create/update/delete/list)\n   - ownership checks and user scoping live in services, not controllers\n3) Optional: a small Facade (`BudgetAppService`) that coordinates workflows involving both incomes and transactions.\n\n## Evidence to grade\n- **Tests:** at least **3 unit tests** on services (mock repositories)\n  - ownership enforcement\n  - create/update happy path\n  - delete rejects wrong user\n- **Design note:** `docs/design-notes/P2-service-layer.md` covering:\n  - where the God Controller / Transaction Script showed up\n  - boundaries you chose (controller vs service vs repository)\n\n## Acceptance criteria\n- Controllers mostly orchestrate (no business rules).\n- Services contain the logic and are unit-tested.\n- Behavior unchanged (except documented bug fixes).'

          # ============================================================
          # P1 (create last so it appears on top when sorted newest)
          # Desired display (top->bottom newest): Home MVC tests -> Validation -> CSRF -> CSV export -> Dashboard -> Static assets -> Sort -> Empty state
          # Create in reverse:
          # ============================================================

          create_and_assign "[P1][S] Add “empty state” UI for new users" "P1,size/S,type/feature,area/ui" $'## Problem / context\nNew users with no data see awkward empty tables and/or broken charts.\n\n## Goal\nProvide a friendly empty-state with clear calls-to-action.\n\n## Work required\n- Update templates to show empty-state cards/messages when there are no incomes/transactions.\n- Add buttons linking to “Add income” / “Add transaction”.\n- Ensure Chart.js does not throw on empty datasets.\n- Ensure totals show 0 (not null).\n\n## Acceptance criteria\n- Pages render cleanly with zero records.\n- No JS console errors due to empty charts.\n- Add an MVC test (preferred) or document manual verification steps.'

          create_and_assign "[P1][S] Sort transactions and incomes by date (newest first)" "P1,size/S,type/refactor" $'## Problem / context\nTransactions/incomes may appear in DB/default order, which is confusing.\n\n## Goal\nShow newest-first ordering consistently.\n\n## Work required\n- Implement sorting at the repository/query level (preferred), e.g. `findByUserIdOrderByDateDesc(...)`.\n- Remove any in-memory or view-layer sorting.\n- Ensure both transactions and incomes are affected.\n\n## Acceptance criteria\n- Lists render newest-first.\n- Sorting is done in repository/query, not in Thymeleaf.\n- Add a repository or service test proving ordering.'

          create_and_assign "[P1][S] Make static assets accessible on landing/login pages" "P1,size/S,type/bug,area/security" $'## Problem / context\nLanding/login styling is broken for anonymous users because security allows `/css/**` and `/js/**` but actual asset paths differ (e.g. `/style.css`, `/images/**`).\n\n## Goal\nAnonymous users can load all static assets required for public pages.\n\n## Work required\n- Inspect landing/login HTML to identify actual asset URLs.\n- Update Spring Security `requestMatchers(...)` to permit those paths.\n- Verify protected pages are still protected.\n- Add either:\n  - a security/MVC test proving anonymous access to at least one static asset path (preferred), OR\n  - a short verification note in README.\n\n## Acceptance criteria\n- Anonymous users receive CSS/JS/images for landing/login without redirects.\n- Protected routes remain protected.\n- Test or documented verification included.'

          # UPDATED: add type/tests label to make "test-focused" selection unambiguous
          create_and_assign "[P1][S] Fix \`/dashboard\` route (missing view)" "P1,size/S,type/bug,type/tests,area/ui" $'## Problem / context\nApp has a `GET /dashboard` mapping but the view/template is missing or invalid, causing a broken navigation path.\n\n## Goal\n`/dashboard` should behave predictably and never throw due to missing templates.\n\n## Work required\n- Choose one approach:\n  1) Implement `dashboard.html` and ensure controller provides required model attributes, OR\n  2) Remove the route and any navigation links pointing to it, OR\n  3) Redirect `/dashboard` to an existing page (e.g. `/home`) and document the rationale.\n- Ensure behavior is consistent for anonymous vs authenticated users.\n- Add an MVC test for the chosen behavior.\n\n## Acceptance criteria\n- Visiting `/dashboard` returns a valid response (200 or expected redirect) and does not throw.\n- At least one automated test asserts the behavior.\n- No dead links remain in templates.'

          # UPDATED: add type/tests label to make "test-focused" selection unambiguous
          create_and_assign "[P1][M] Improve CSV export: consistent quoting + file name includes date" "P1,size/M,type/feature,type/tests,anchor/patterns,anchor/smells-antipatterns" $'## Smell / anti-pattern to address\n- **Duplicate Code** and **Ad-hoc String Building**\n\n## Pattern required\n- **Template Method** (export skeleton)\n- **Strategy** (escaping/quoting rules)\n\n## Context\nCSV export often turns into fragile string concatenation and breaks on commas/quotes/newlines.\n\n## Work required\n1) Refactor export into a small module:\n   - `AbstractCsvExporter` implements Template Method: write headers -> iterate rows -> format cells -> write response\n2) Implement `CsvEscaper` as a Strategy for quoting/escaping.\n3) Set `Content-Disposition` filename like `transactions-YYYY-MM.csv`.\n4) Ensure stable column order and header row.\n\n## Evidence to grade\n- **Tests:** at least **2 unit tests**\n  - escaping for commas/quotes/newlines\n  - filename header includes expected date/month format\n- **Design note:** `docs/design-notes/P1-csv-export.md` explaining:\n  - what was ad-hoc string building\n  - why Template Method + Strategy is a better extension point\n\n## Acceptance criteria\n- CSV imports cleanly into Excel/Sheets with special characters.\n- Filename includes date/month.\n- Tests pass in CI.'

          create_and_assign "[P1][M] Fix/clarify CSRF behavior for AJAX delete endpoints" "P1,size/M,type/bug,area/security,type/tests,anchor/patterns,anchor/smells-antipatterns" $'## Smell / anti-pattern to address\n- **Security Misconfiguration** and the **"Just disable CSRF"** anti-pattern\n\n## Pattern required\n- **Synchronizer Token Pattern** (CSRF token carried with the request)\n\n## Context\nAJAX-based deletes may fail with 403 due to missing CSRF tokens. Disabling CSRF globally is not acceptable.\n\n## Work required\n1) Identify delete endpoints used by the UI.\n2) Implement CSRF token propagation:\n   - render token into page (meta tag or hidden input)\n   - include token in `fetch()` requests (header or body), OR refactor to a form POST\n3) Ensure anonymous users cannot delete, and authenticated users can delete reliably.\n\n## Evidence to grade\n- **Tests:** at least **2 security/MVC tests**\n  - delete without CSRF -> rejected (403)\n  - delete with CSRF + authenticated -> succeeds\n- **Design note:** `docs/design-notes/P1-csrf.md` covering:\n  - why disabling CSRF is an anti-pattern\n  - the exact mechanism used (headers vs forms)\n\n## Acceptance criteria\n- Delete works for authenticated users with CSRF enabled.\n- Anonymous/unauthorized requests cannot delete.\n- Tests pass in CI.'

          create_and_assign "[P1][M] Add bean validation to \`Transaction\` and \`Income\` + show errors in UI" "P1,size/M,type/feature,type/tests,anchor/patterns,anchor/smells-antipatterns" $'## Smell / anti-pattern to address\n- **Primitive Obsession** and **Missing Validation / Invariants Not Enforced**\n\n## Pattern required\n- **Command Object** (Form/DTO separate from entities)\n- **Notification Pattern** (collect and display validation errors)\n\n## Context\nInvalid inputs (blank titles, missing dates, negative/zero amounts) can slip through and/or fail late.\n\n## Work required\n1) Create command objects (e.g., `TransactionForm`, `IncomeForm`) separate from JPA entities.\n2) Apply Bean Validation annotations on form objects (`@NotBlank`, `@NotNull`, `@DecimalMin`, etc.).\n3) In controllers:\n   - bind to `@Valid <Form>` + `BindingResult`\n   - on failure, return the form view, preserve user input, and show field-level errors\n4) Map valid forms -> entities in a service method (avoid mapping logic scattered in controllers).\n\n## Evidence to grade\n- **Tests:** at least **2 MVC tests**\n  - invalid submission returns 200 and shows errors (and does not write to DB)\n  - valid submission succeeds (redirect and DB write)\n- **Design note:** add `docs/design-notes/P1-validation.md` explaining:\n  - what Primitive Obsession looked like here\n  - why Command Objects reduce risk vs validating entities directly\n  - how you surface errors (Notification Pattern via BindingResult)\n\n## Acceptance criteria\n- Invalid submissions do not persist.\n- UI shows clear field-level messages and preserves entered values.\n- Tests pass in CI.'

          create_and_assign "[P1][M] Add first meaningful tests for \`TransactionController#home\`" "P1,size/M,type/tests" $'## Problem / context\nCore controller behavior is untested.\n\n## Goal\nEstablish baseline MVC tests (auth vs anonymous + required model attributes).\n\n## Work required\n- Add Spring MVC tests covering:\n  - anonymous user -> expected landing/login behavior\n  - authenticated user -> returns `home` view and includes required model keys\n- Use `spring-security-test` helpers (`@WithMockUser` or equivalent).\n- Keep assertions stable (view name + presence of model keys).\n\n## Acceptance criteria\n- Tests pass locally and in CI.\n- Tests assert view name and required model attributes are present.\n- Brief note in README or test comments on how to run.'

          echo "Assigning milestones to ALL existing issues by [P#] prefix (reliable pass)..." >&2
          assign_all_existing_issues_to_milestones

          echo "Done." >&2
