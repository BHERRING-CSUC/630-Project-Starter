name: Bootstrap Labels + Issue Menu

on:
  push:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      force:
        description: "Re-run even if labels/issues already exist"
        required: false
        default: "false"

permissions:
  contents: read
  issues: write

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    steps:
      - name: Bootstrap labels and issues via GitHub REST API
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          FORCE: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.force) || 'false' }}
        run: |
          set -euo pipefail

          api_json() {
            local method="$1"
            local path="$2"
            local data="${3:-}"
            local url="https://api.github.com${path}"
            local resp_file
            resp_file="$(mktemp)"

            if [[ -n "${data}" ]]; then
              API_STATUS="$(curl -sS -o "${resp_file}" -w "%{http_code}" \
                -X "${method}" \
                -H "Accept: application/vnd.github+json" \
                -H "Authorization: Bearer ${GH_TOKEN}" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                "${url}" \
                -d "${data}")"
            else
              API_STATUS="$(curl -sS -o "${resp_file}" -w "%{http_code}" \
                -X "${method}" \
                -H "Accept: application/vnd.github+json" \
                -H "Authorization: Bearer ${GH_TOKEN}" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                "${url}")"
            fi

            cat "${resp_file}"
            rm -f "${resp_file}"
          }

          urlencode() {
            python3 -c 'import urllib.parse,sys; print(urllib.parse.quote(sys.argv[1], safe=""))' "$1"
          }

          label_exists() {
            local name="$1"
            local enc
            enc="$(urlencode "$name")"
            api_json GET "/repos/${REPO}/labels/${enc}" >/dev/null
            [[ "${API_STATUS}" == "200" ]]
          }

          ensure_label() {
            local name="$1"
            local color="$2"
            local desc="$3"
            local enc
            enc="$(urlencode "$name")"

            local payload
            payload="$(jq -n --arg name "$name" --arg color "$color" --arg description "$desc" \
              '{name:$name,color:$color,description:$description}')"

            api_json POST "/repos/${REPO}/labels" "${payload}" >/dev/null
            if [[ "${API_STATUS}" == "201" ]]; then
              echo "Created label: ${name}"
              return 0
            fi

            # 422 = already exists (or validation)
            if [[ "${API_STATUS}" == "422" ]]; then
              local patch
              patch="$(jq -n --arg new_name "$name" --arg color "$color" --arg description "$desc" \
                '{new_name:$new_name,color:$color,description:$description}')"
              api_json PATCH "/repos/${REPO}/labels/${enc}" "${patch}" >/dev/null
              if [[ "${API_STATUS}" == "200" ]]; then
                echo "Updated label: ${name}"
                return 0
              fi
            fi

            echo "ERROR: ensure_label failed for ${name} (HTTP ${API_STATUS})"
            api_json GET "/repos/${REPO}" >/dev/null || true
            exit 1
          }

          issue_exists_by_title() {
            local title="$1"
            local q
            q="repo:${REPO} in:title \"${title}\""
            local encq
            encq="$(python3 -c 'import urllib.parse,sys; print(urllib.parse.quote(sys.argv[1]))' "$q")"

            local results
            results="$(api_json GET "/search/issues?q=${encq}")"
            if [[ "${API_STATUS}" != "200" ]]; then
              echo "ERROR: search/issues failed (HTTP ${API_STATUS})"
              echo "${results}"
              exit 1
            fi

            echo "${results}" | jq -r '.items[].title' | grep -Fxq "${title}"
          }

          create_issue() {
            local title="$1"
            local labels_csv="$2"
            local body="$3"

            if issue_exists_by_title "${title}"; then
              echo "Skipping existing issue: ${title}"
              return 0
            fi

            local labels_json
            labels_json="$(printf '%s' "${labels_csv}" \
              | awk -F',' '{for (i=1;i<=NF;i++) print $i}' \
              | sed '/^\s*$/d' \
              | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' \
              | jq -R . | jq -s .)"

            local payload
            payload="$(jq -n \
              --arg title "${title}" \
              --arg body "${body}" \
              --argjson labels "${labels_json}" \
              '{title:$title, body:$body, labels:$labels}')"

            api_json POST "/repos/${REPO}/issues" "${payload}" >/dev/null
            if [[ "${API_STATUS}" == "201" ]]; then
              echo "Created issue: ${title}"
              return 0
            fi

            echo "ERROR: create_issue failed (HTTP ${API_STATUS}) for ${title}"
            exit 1
          }

          echo "Repo: ${REPO}"
          echo "Force: ${FORCE}"

          if [[ "${FORCE}" != "true" ]]; then
            if label_exists "P1"; then
              echo "Looks already bootstrapped (label P1 exists)."
              exit 0
            fi
          fi

          echo "Creating labels..."
          ensure_label "P1" "1f77b4" "Project 1"
          ensure_label "P2" "ff7f0e" "Project 2"
          ensure_label "P3" "2ca02c" "Project 3"
          ensure_label "P4" "d62728" "Project 4"

          ensure_label "size/S" "a1d99b" "Small scope"
          ensure_label "size/M" "74c476" "Medium scope"
          ensure_label "size/L" "238b45" "Large scope"

          ensure_label "type/bug" "e15759" "Bug fix"
          ensure_label "type/refactor" "4e79a7" "Refactoring / design cleanup"
          ensure_label "type/feature" "59a14f" "New feature"
          ensure_label "type/tests" "f28e2b" "Testing work"
          ensure_label "type/devops" "edc949" "DevOps / CI / release"

          ensure_label "area/ui" "76b7b2" "UI / UX"
          ensure_label "area/security" "b07aa1" "Security / auth"
          ensure_label "area/data" "9c755f" "Data model / DB"

          echo "Creating issue menu..."
          create_issue "[P1][S] Fix \`/dashboard\` route (missing view)" "P1,size/S,type/bug,area/ui" "Problem: Controller has \`@GetMapping(\"/dashboard\")\` but no \`dashboard.html\` template.\n\nAcceptance criteria\n- Visiting \`/dashboard\` while logged in returns a valid page (either create \`dashboard.html\` or remove/redirect route).\n- Add at least one MVC test proving the behavior.\n\nNotes\n- If you keep it: reuse model attributes already computed in controller."
          create_issue "[P1][S] Make static assets accessible on landing/login pages" "P1,size/S,type/bug,area/security" "Problem: Security config permits \`/css/**\` and \`/js/**\`, but the repo uses \`src/main/resources/static/style.css\` (served at \`/style.css\`).\n\nAcceptance criteria\n- Landing + login pages load CSS without authentication.\n- Add a test (or document manual verification) showing unauthenticated access to the CSS path.\n\nHint\n- Update \`requestMatchers(...)\` to permit the actual static paths used."

          # NOTE: For brevity here, keep the rest of your 30 create_issue(...) calls exactly as before.
          # Paste the remaining create_issue calls from your existing workflow beneath this point.

          echo "Done."
